# 对话自动保存功能使用指南

## 📋 功能概述

教育导师学习对话系统现已支持**自动保存**功能，学习者登录后与教育导师的学习对话记录将自动保存到PostgreSQL数据库中，同时保持本地存储作为备份。学习者可以随时查看历史学习对话记录。

## 🚀 核心特性

### 1. 双重存储机制
- **本地存储**: 所有学习对话都会保存到浏览器本地存储（作为备份）
- **云端数据库**: 学习者登录后，学习对话自动同步到PostgreSQL数据库

### 2. 自动保存触发
- 每次发送学习消息后自动触发保存
- 学习对话创建时自动保存基本信息
- 页面关闭前自动保存当前学习状态

### 3. 历史记录查看
- 支持分页浏览历史学习对话
- 实时搜索学习对话标题和内容
- 按教育导师、时间、消息数量筛选和排序
- 查看学习对话详情和完整学习消息记录

## 🔧 使用方法

### 步骤1: 环境准备

1. **确保PostgreSQL数据库运行**
   ```bash
   # 运行数据库设置脚本
   setup-postgresql.bat
   ```

2. **启动后端服务**
   ```bash
   cd backend
   npm start
   ```

3. **访问前端应用**
   - 打开浏览器访问学习对话页面
   - 确保学习者已登录（有认证令牌）

### 步骤2: 开始学习对话

1. **选择教育导师**
   - 在教育导师选择页面选择您想要对话的导师
   - 系统会自动创建新的学习对话记录

2. **发送学习问题**
   - 在对话框中输入您的学习问题
   - 点击发送按钮或按Enter键
   - 系统会自动保存学习者消息和教育导师回复

3. **查看保存状态**
   - 浏览器控制台会显示保存状态日志
   - 成功保存会显示"学习对话已保存到数据库"

### 步骤3: 查看历史记录

1. **打开历史记录**
   - 在学习对话页面点击"历史记录"按钮
   - 系统会打开历史学习记录模态框

2. **浏览和搜索**
   - 使用搜索框查找特定学习对话
   - 使用筛选器按教育导师或时间排序
   - 点击学习对话项查看详细内容

3. **学习对话操作**
   - 继续学习：回到该学习对话继续交流
   - 导出对话：将学习对话导出为文件
   - 收藏/置顶：标记重要学习对话

## 📊 数据结构说明

### 学习对话表 (conversations)
```sql
- id: 主键ID
- uuid: 唯一标识符
- user_id: 学习者ID
- title: 学习对话标题
- description: 学习对话描述
- mode: 对话模式 (single/group)
- primary_mentor_id: 主要教育导师ID
- primary_mentor_name: 主要教育导师名称
- status: 状态 (active/archived/deleted)
- tags: 学习标签数组
- metadata: 元数据 (JSON)
- created_at: 创建时间
- updated_at: 更新时间
```

### 学习消息表 (conversation_messages)
```sql
- id: 主键ID
- uuid: 唯一标识符
- conversation_id: 所属学习对话ID
- role: 消息角色 (user/assistant/system)
- content: 学习消息内容
- content_type: 内容类型 (text/image/file)
- message_order: 消息顺序
- mentor_id: 教育导师ID (如果是AI回复)
- mentor_name: 教育导师名称
- status: 状态 (sent/delivered/read)
- metadata: 元数据 (JSON)
- created_at: 创建时间
```

## 🔍 测试和调试

### 使用测试页面
1. **打开测试页面**
   ```bash
   # 运行测试脚本
   test-conversation-autosave.bat
   ```

2. **执行测试流程**
   - 模拟学习者登录
   - 测试数据库连接
   - 创建测试学习对话
   - 发送测试学习消息
   - 验证自动保存

### 查看日志
- **浏览器控制台**: 查看前端学习对话保存日志
- **后端日志**: 查看API调用和数据库操作日志
- **数据库日志**: 直接查询数据库验证学习数据

### 常见问题排查

1. **学习对话没有保存到数据库**
   - 检查学习者是否已登录 (`localStorage.getItem('auth_token')`)
   - 检查后端服务是否运行 (`http://localhost:3001`)
   - 检查数据库连接是否正常

2. **学习历史记录加载失败**
   - 检查API权限和认证令牌
   - 检查网络连接和跨域设置
   - 查看浏览器控制台错误信息

3. **学习消息保存顺序错误**
   - 检查`message_order`字段设置
   - 确认并发保存的处理逻辑
   - 验证数据库事务完整性

## 🛡️ 安全考虑

### 数据保护
- 所有API调用都需要有效的认证令牌
- 学习者只能访问自己的学习对话记录
- 敏感学习信息在传输过程中加密

### 权限控制
- 学习对话归属验证：确保学习者只能操作自己的学习对话
- API访问控制：防止未授权的数据访问
- 软删除机制：删除的学习数据仍保留在数据库中

### 数据备份
- 本地存储作为主要备份机制
- 定期数据库备份（生产环境）
- 导出功能支持学习者自主备份

## 📈 性能优化

### 前端优化
- 分页加载：避免一次加载过多学习历史记录
- 缓存机制：减少重复的API调用
- 异步保存：不阻塞学习者界面操作

### 后端优化
- 连接池：高效管理数据库连接
- 索引优化：提高学习数据查询性能
- 批量操作：减少数据库调用次数

### 数据库优化
- 合理的索引设计
- 定期清理过期数据
- 查询性能监控

## 🔄 版本更新

### v1.0 功能
- ✅ 基本的学习对话自动保存功能
- ✅ 本地和云端双重存储
- ✅ 学习历史记录查看界面
- ✅ 基本的搜索和筛选

### 计划中的功能
- 🔲 学习对话分享和协作
- 🔲 智能学习标签自动分类
- 🔲 学习对话摘要和洞察
- 🔲 高级学习搜索和分析

## 📞 技术支持

如果您在使用过程中遇到问题：

1. **查看日志**: 检查浏览器控制台和后端日志
2. **运行测试**: 使用测试脚本验证功能
3. **检查配置**: 确认数据库和API配置正确
4. **重启服务**: 尝试重启后端服务和数据库

---

**注意**: 该学习对话功能需要PostgreSQL数据库支持，请确保按照部署指南正确配置数据库环境。