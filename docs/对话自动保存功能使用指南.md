# 对话自动保存功能使用指南

## 📋 功能概述

AI导师对话系统现已支持**自动保存**功能，用户登录后与导师的对话记录将自动保存到PostgreSQL数据库中，同时保持本地存储作为备份。用户可以随时查看历史对话记录。

## 🚀 核心特性

### 1. 双重存储机制
- **本地存储**: 所有对话都会保存到浏览器本地存储（作为备份）
- **云端数据库**: 用户登录后，对话自动同步到PostgreSQL数据库

### 2. 自动保存触发
- 每次发送消息后自动触发保存
- 对话创建时自动保存基本信息
- 页面关闭前自动保存当前状态

### 3. 历史记录查看
- 支持分页浏览历史对话
- 实时搜索对话标题和内容
- 按导师、时间、消息数量筛选和排序
- 查看对话详情和完整消息记录

## 🔧 使用方法

### 步骤1: 环境准备

1. **确保PostgreSQL数据库运行**
   ```bash
   # 运行数据库设置脚本
   setup-postgresql.bat
   ```

2. **启动后端服务**
   ```bash
   cd backend
   npm start
   ```

3. **访问前端应用**
   - 打开浏览器访问对话页面
   - 确保用户已登录（有认证令牌）

### 步骤2: 开始对话

1. **选择导师**
   - 在导师选择页面选择您想要对话的导师
   - 系统会自动创建新的对话记录

2. **发送消息**
   - 在对话框中输入您的问题
   - 点击发送按钮或按Enter键
   - 系统会自动保存用户消息和AI回复

3. **查看保存状态**
   - 浏览器控制台会显示保存状态日志
   - 成功保存会显示"对话已保存到数据库"

### 步骤3: 查看历史记录

1. **打开历史记录**
   - 在对话页面点击"历史记录"按钮
   - 系统会打开历史记录模态框

2. **浏览和搜索**
   - 使用搜索框查找特定对话
   - 使用筛选器按导师或时间排序
   - 点击对话项查看详细内容

3. **对话操作**
   - 继续对话：回到该对话继续交流
   - 导出对话：将对话导出为文件
   - 收藏/置顶：标记重要对话

## 📊 数据结构说明

### 对话表 (conversations)
```sql
- id: 主键ID
- uuid: 唯一标识符
- user_id: 用户ID
- title: 对话标题
- description: 对话描述
- mode: 对话模式 (single/group)
- primary_mentor_id: 主导师ID
- primary_mentor_name: 主导师名称
- status: 状态 (active/archived/deleted)
- tags: 标签数组
- metadata: 元数据 (JSON)
- created_at: 创建时间
- updated_at: 更新时间
```

### 消息表 (conversation_messages)
```sql
- id: 主键ID
- uuid: 唯一标识符
- conversation_id: 所属对话ID
- role: 消息角色 (user/assistant/system)
- content: 消息内容
- content_type: 内容类型 (text/image/file)
- message_order: 消息顺序
- mentor_id: 导师ID (如果是AI回复)
- mentor_name: 导师名称
- status: 状态 (sent/delivered/read)
- metadata: 元数据 (JSON)
- created_at: 创建时间
```

## 🔍 测试和调试

### 使用测试页面
1. **打开测试页面**
   ```bash
   # 运行测试脚本
   test-conversation-autosave.bat
   ```

2. **执行测试流程**
   - 模拟用户登录
   - 测试数据库连接
   - 创建测试对话
   - 发送测试消息
   - 验证自动保存

### 查看日志
- **浏览器控制台**: 查看前端保存日志
- **后端日志**: 查看API调用和数据库操作日志
- **数据库日志**: 直接查询数据库验证数据

### 常见问题排查

1. **对话没有保存到数据库**
   - 检查用户是否已登录 (`localStorage.getItem('auth_token')`)
   - 检查后端服务是否运行 (`http://localhost:3001`)
   - 检查数据库连接是否正常

2. **历史记录加载失败**
   - 检查API权限和认证令牌
   - 检查网络连接和跨域设置
   - 查看浏览器控制台错误信息

3. **消息保存顺序错误**
   - 检查`message_order`字段设置
   - 确认并发保存的处理逻辑
   - 验证数据库事务完整性

## 🛡️ 安全考虑

### 数据保护
- 所有API调用都需要有效的认证令牌
- 用户只能访问自己的对话记录
- 敏感信息在传输过程中加密

### 权限控制
- 对话归属验证：确保用户只能操作自己的对话
- API访问控制：防止未授权的数据访问
- 软删除机制：删除的数据仍保留在数据库中

### 数据备份
- 本地存储作为主要备份机制
- 定期数据库备份（生产环境）
- 导出功能支持用户自主备份

## 📈 性能优化

### 前端优化
- 分页加载：避免一次加载过多历史记录
- 缓存机制：减少重复的API调用
- 异步保存：不阻塞用户界面操作

### 后端优化
- 连接池：高效管理数据库连接
- 索引优化：提高查询性能
- 批量操作：减少数据库调用次数

### 数据库优化
- 合理的索引设计
- 定期清理过期数据
- 查询性能监控

## 🔄 版本更新

### v1.0 功能
- ✅ 基本的自动保存功能
- ✅ 本地和云端双重存储
- ✅ 历史记录查看界面
- ✅ 基本的搜索和筛选

### 计划中的功能
- 🔲 对话分享和协作
- 🔲 智能标签自动分类
- 🔲 对话摘要和洞察
- 🔲 高级搜索和分析

## 📞 技术支持

如果您在使用过程中遇到问题：

1. **查看日志**: 检查浏览器控制台和后端日志
2. **运行测试**: 使用测试脚本验证功能
3. **检查配置**: 确认数据库和API配置正确
4. **重启服务**: 尝试重启后端服务和数据库

---

**注意**: 该功能需要PostgreSQL数据库支持，请确保按照部署指南正确配置数据库环境。 